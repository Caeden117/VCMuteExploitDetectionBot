using DSharpPlus;
using DSharpPlus.Entities;
using System;
using VCMuteExploitDetectionBot.Configuration;

namespace VCMuteExploitDetectionBot.Services
{
    public class LogToChannelService
    {
        private readonly DiscordChannel logChannel;
        private readonly Config config;
        private readonly DiscordGuild guild;

        public LogToChannelService(ExploitDetectionService exploitDetection, Config config, DiscordGuild guild)
        {
            this.config = config;
            this.guild = guild;

            if (string.IsNullOrWhiteSpace(config.LogChannelID)) return;

            var logChannelID = ulong.Parse(config.LogChannelID);

            logChannel = guild.GetChannel(logChannelID);

            exploitDetection.FakeMuteExploitDetected += ExploitDetection_FakeMuteExploitDetected;
        }

        private async void ExploitDetection_FakeMuteExploitDetected(AbuseTracker _, DiscordUser user)
        {
            if (user is null)
            {
                await Logger.Error("Log Channel", "User who attempted exploit is somehow null; cannot continue logging.");
                return;
            }

            if (guild is null)
            {
                await Logger.Error("Log Channel", "Guild is somehow null; cannot continue logging.");
                return;
            }

            var embed = new DiscordEmbedBuilder()
                .WithTitle("🔊 Fake Mute/Deaf Exploit Detected")
                .WithAuthor($"{user.Username}#{user.Discriminator} [{user.Id}]", null, user.GetAvatarUrl(ImageFormat.Auto))
                .WithColor(new DiscordColor(config.LogChannelEmbedColor))
                .WithFooter(guild.Name)
                .WithTimestamp(DateTime.Now)
                .AddField("Voice Channel", $"<#{config.ChannelID}>", true)
                .AddField("Action Taken", config.BanDetectedUsers ? "This user was banned." : "No action taken.", true)
                .Build();

            await logChannel.SendMessageAsync(null, false, embed);
        }
    }
}
